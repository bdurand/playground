name: Deploy To Staging

on:
  push:
    branches:
      - main
      - pre-release
      - hotfix

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Get branch to build
        id: ref_to_build
        uses: actions/github-script@v6
        with:
          script: |
            let buildBranch = 'main';
            const branches = ['hotfix', 'pre-release'];
            for (let i = 0; i < branches.length; i++) {
              branchName = branches[i];
              try {
                await github.repos.getBranch({
                  owner: owner,
                  repo: repo,
                  branch: branchName
                });
                buildBranch = branchName;
                break;
              } catch (error) {
                continue;
              }
            }

            const refToBuild = `refs/heads/${buildBranch}`;
            if (context.ref !== refToBuild) {
              core.warning(`Not deploying to staging; current build branch is ${buildBranch}`);
            }
            console.log(context)
            console.log(refToBuild)
            return refToBuild;
      - name: debug
        run: |
          echo "debug"
          echo ${{ steps.ref_to_build.outputs.result }}
      - name: Build Docker image
        if: github.event.ref == steps.ref_to_build.outputs.result
        run: |
          echo "Build Docker image"
      - name: Run deployment
        if: github.event.ref == steps.ref_to_build.outputs.result
        run: |
          echo "Deploying ${GITHUB_REF} to staging (${GITHUB_SHA})"
